name: Build CBDB RPMS
on:
  schedule:
    - cron: '22 7 * * *'
  push:
     branches: [zbw-test-runner]

jobs:
  Build-rpm:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
        with:
          ref: zbw-test-runner
      - name: run scripts
        run: |

          wget https://public-artifacts.obs.myhuaweicloud.com/2024-04-28script/script.tar.gz
          pwd
          ls -al
          tar -xvf script.tar.gz
          git config --global user.name "zhangbaowen"
          git config --global user.email "zhangbaowen@hashdata.cn"
          pwd
          ls -l
          source script/build_cbdb_env.sh
          git clone git@github.com:cloudberrydb/cloudberrydb.git
          cd cloudberrydb
          ./configure --with-perl --with-python --with-libxml --with-gssapi --prefix=/home/gpadmin/cbdb-install
          make -j16
          make install
          pwd
          ruby -v
          fpm --version
          echo "制作rpm包"
          mkdir -p tmp/usr/local/cloudberrydb
          sudo cp -a /home/gpadmin/cbdb-install/* tmp/usr/local/cloudberrydb
          fpm -s dir -t rpm -n cloudberrydb -v 1.5.2 -p ./ -C tmp
          pwd
          ls -al
          mkdir /home/gpadmin/actions-runner/zbw-2/zbw-test-actions/zbw-test-actions/cloudberrydb/cbdb-packages
          cp cloudberrydb-1.5.2-1.x86_64.rpm /home/gpadmin/actions-runner/zbw-2/zbw-test-actions/zbw-test-actions/cloudberrydb/cbdb-packages
      - name: Upload artifact
        uses: actions/upload-artifact@v1.0.0
        with:
          name: Binary RPM
          path: /home/gpadmin/actions-runner/zbw-2/zbw-test-actions/zbw-test-actions/cloudberrydb/cbdb-packages




name: Create Release with Download Page

on:
  push:
    branches:
      - release-cbdb-nightly  # 当在main分支上有代码推送时触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v7.0.0  # 发布的标签名称
        release_name: Release v7.0.0  # 发布的名称
        body: This is the release notes for version 7.0.0  # 发布的说明
    - name: run script
        run: |
          mkdir /tmp/release
          wget https://public-artifacts.obs.myhuaweicloud.com/2024-04-28script/script.tar.gz
          pwd
          cp script.tar.gz /tmp/release
    - name: Upload Files
      uses: actions/upload-artifact@v2
      with:
        name: my-artifact
        path: /tmp/release  # 上传文件的路径

    - name: Deploy Download Page
      run: |
        echo "<html><body><a href='https://github.com/your-username/your-repo/releases/download/v1.0.0/your-file.zip'>Download File</a></body></html>" > download.html
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Publish Download Page
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        publish_branch: gh-pages
        
        
        
        
        
        
        
        